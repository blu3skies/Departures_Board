<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ station }} Board</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <script src="{{ url_for('static', filename='app.js') }}"></script>
</head>
<body>
  <div class="screen">
    <div class="header">
      <div class="title">London Home Travel Board </div>
      <div class="header-center">{{ current_datetime }}</div>
      <div class="panel-updated">Updated: {{ updated }}</div>
    </div>

    <div class="layout">
      <!-- Tube Status -->
      <aside class="panel tube-panel">
        <div class="panel-title">London Underground Status</div>

        {% if tube_has_data and (tubes or tube_good_summary) %}
          <div class="tube-status-list">
            {% for t in tubes %}
              <div class="tube-row {{ t.severity }}" style="--tube-color: {{ t.color | default('#3f3f46') }}">
                <div class="tube-name">{{ t.name }}</div>
                <div class="tube-status-text">{{ t.status }}</div>

                {% if t.reason %}
                <div class="tube-reason-container">
                  <button type="button" class="reason-toggle">Show details</button>
                  <div class="tube-reason-popup">{{ t.reason }}</div>
                </div>
                {% endif %}
              </div>
            {% endfor %}

            {% if tube_good_summary %}
              <div class="tube-row tube-summary">
                <div class="tube-summary-swatches">
                  {% for colour in tube_good_colours %}
                    <span style="background: {{ colour }}"></span>
                  {% endfor %}
                </div>
                <div class="tube-name"></div>
                <div class="tube-status-text">{{ tube_good_summary }}</div>
              </div>
            {% endif %}
          </div>
        {% elif tube_has_data %}
          <div class="muted">No current disruptions.</div>
        {% else %}
          <div class="muted">Tube status unavailable</div>
        {% endif %}
      </aside>

      <!-- Train Departures -->
      <main class="panel train-panel">
        <div class="panel-title">Upcoming departures for Herne Hill</div>

        {% if trains %}
          <table class="departures-table">
            <thead>
              <tr><th>Time</th><th>Destination</th><th>Plat</th><th>Status</th><th>Operator</th></tr>
            </thead>
            <tbody>
              {% for platform, rows in trains.items() %}
                <tr>
                  <td colspan="5" style="color: var(--teletext-yellow); font-weight: bold; border-bottom: 1px solid var(--teletext-yellow); background: #000;">
                    Platform {{ platform }}
                  </td>
                </tr>
                {% for t in rows %}
                  {% set is_late = (t.get('etd','')|lower) not in ['on time','due',''] %}
                  <tr>
                    {% if t is mapping %}
                      <td class="time {% if is_late %}late{% else %}ontime{% endif %}">
                        {{ t.get('std') or t.get('time') or '' }}
                      </td>
                      <td>{{ t.get('destination') or t.get('dest') or 'Unknown' }}</td>
                      <td>{{ t.get('platform') or '-' }}</td>
                      <td class="status {% if is_late %}late{% else %}ontime{% endif %}">
                        {{ t.get('etd') or 'On time' }}
                        {% if t.get('due_in_mins') %}
                          ({{ t.get('due_in_mins') }} min{{ 's' if t.get('due_in_mins') > 1 else '' }})
                        {% endif %}
                      </td>
                      <td>{{ t.get('operator') or t.get('operatorName') or '' }}{% if t.get('operatorCode') %} ({{ t.get('operatorCode') }}){% endif %}</td>
                    {% else %}
                      <td colspan="5">{{ t }}</td>
                    {% endif %}
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">No train departures available</div>
        {% endif %}
      </main>

      <!-- Bus Arrivals -->
      <section class="panel bus-panel">
        <div class="panel-title">Buses to Brixton</div>

        {% if buses %}
          <table class="bus-table">
            <thead><tr><th>Line</th><th>Destination</th><th>In</th></tr></thead>
            <tbody>
              {% for b in buses %}
                <tr>
                  <td>{{ b.get('line') or b.get('route') or b.get('service') or '—' }}</td>
                  <td>{{ b.get('destination') or b.get('towards') or 'Unknown' }}</td>
                  <td>{{ b.get('expected_in_min') or '—' }} min</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">No bus info</div>
        {% endif %}
      </section>

      <!-- Weather -->
      <section class="panel weather-panel">
        <div class="panel-title">Today's Weather</div>

        {% if weather %}
          {% set segments = [] %}
          {% if weather.get('segments') %}
            {% for key, seg in weather.get('segments').items() %}
              {% set _ = segments.append({
                'title': key|capitalize,
                'rain_probability': seg.get('rain_probability'),
                'rain_intensity': seg.get('rain_intensity'),
                'sky_icon': seg.get('sky_icon'),
                'wind_speed': seg.get('wind_speed'),
                'wind_gusts': seg.get('wind_gusts'),
                'wind_dir': seg.get('wind_dir')
              }) %}
            {% endfor %}
          {% endif %}
        {% endif %}

        {% if segments %}
          <div class="weather-grid">
            {% for seg in segments %}
              <div class="weather-seg">
                <div class="seg-icon">{{ seg.sky_icon }}</div>
                <div class="seg-info">
                  <div class="seg-title">{{ seg.title }}</div>
                  <div class="seg-line">{{ seg.rain_probability }}% rain</div>
                  <div class="seg-line">{{ seg.wind_speed }} km/h {{ seg.wind_dir }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="muted">
            <span class="high">High:</span> {{ weather.high_temp }}° • 
            <span class="low">Low:</span> {{ weather.low_temp }}° • 
            Sunrise: {{ weather.sunrise }} • Sunset: {{ weather.sunset }}
          </div>
        {% else %}
          <div class="muted">Weather unavailable</div>
        {% endif %}
      </section>
    </div>

    <div class="footer">
      <div class="muted">Data sources: National Rail / TFL / Weather</div>
      <div class="muted">Board auto-refreshes every 60 s</div>
    </div>
  </div>
</body>
</html>