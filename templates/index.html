<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ station }} Board</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <script src="{{ url_for('static', filename='app.js') }}"></script>
</head>
<body>
  <div class="screen">
    <div class="header">
      <div class="title">London Board — {{ station }}</div>
      <div class="panel-updated">Updated: {{ updated }}</div>
    </div>

    <div class="layout">
      <aside class="left panel">
        <div class="panel-title">TFL Tube Status</div>

        {% if tube_has_data and (tubes or tube_good_summary) %}
          <div class="tube-status-list">
            {% for t in tubes %}
              <div class="tube-row {{ t.severity }}" style="--tube-color: {{ t.color | default('#3f3f46') }}">
                <div class="tube-name">{{ t.name }}</div>
                <div class="tube-status-text">{{ t.status }}</div>

                {% if t.reason %}
                <div class="tube-reason-container">
                  <button type="button" class="reason-toggle">Show details</button>
                  <div class="tube-reason-popup">{{ t.reason }}</div>
                </div>
                {% endif %}
              </div>
            {% endfor %}

            {% if tube_good_summary %}
              <div class="tube-row tube-summary">
                <div class="tube-name">Good service</div>
                <div class="tube-status-text">{{ tube_good_summary }}</div>
              </div>
            {% endif %}
          </div>
        {% elif tube_has_data %}
          <div class="muted">No current disruptions.</div>
        {% else %}
          <div class="muted">Tube status unavailable</div>
        {% endif %}

        <div class="spacer"></div>

        <div class="panel-subtitle">Nearby Buses</div>

        {% macro bus_dest(b) -%}
          {%- if b is mapping -%}
            {{ b.get('destination') or b.get('towards') or b.get('toward') or b.get('stop_name') or 'Unknown' }}
          {%- else -%}
            {{ b }}
          {%- endif -%}
        {%- endmacro %}

        {% macro bus_time_display(b) -%}
          {% if b is mapping %}
            {% set tts = (b.get('time_to_station') or b.get('timeToStation') or b.get('timeToStationSecs') or b.get('time_to_station_secs')) %}
            {% if tts is not none %}
              {% set mins = (tts|int // 60) %}
              {{ 'Due' if mins == 0 else (mins ~ ' min') }}
            {% else %}
              {{ b.get('expectedArrival') or b.get('displayTime') or b.get('time') or b.get('eta') or '—' }}
            {% endif %}
          {% else %}
            {{ b }}
          {% endif %}
        {%- endmacro %}

        {% if buses %}
          <table class="bus-table">
            <thead><tr><th>Line</th><th>Destination</th><th>In</th></tr></thead>
            <tbody>
              {% for b in buses %}
                <tr>
                  <td>
                    {% if b is mapping %}
                      {{ b.get('line') or b.get('route') or b.get('service') or '—' }}
                    {% else %}
                      {{ b }}
                    {% endif %}
                  </td>
                  <td>{{ bus_dest(b) }}</td>
                  <td>{{ bus_time_display(b) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">No bus info</div>
        {% endif %}

        <div class="spacer"></div>

        <div class="panel-subtitle">Other info</div>
        <div class="muted">Press F11 on a desktop browser for kiosk full-screen. Page auto-refreshes every 60 s.</div>
      </aside>

      <main class="right panel">
        <div class="panel-title">Upcoming departures for {{ station }}</div>

        {% if trains %}
          {% for platform, rows in trains.items() %}
            <div class="platform-block">
              <h3>Platform {{ platform }}</h3>
              <table class="departures-table">
                <thead>
                  <tr><th>Time</th><th>Destination</th><th>Plat</th><th>Status</th><th>Operator</th></tr>
                </thead>
                <tbody>
                  {% for t in rows %}
                    <tr>
                      {% if t is mapping %}
                        <td>{{ t.get('std') or t.get('time') or '' }}</td>
                        <td>{{ t.get('destination') or t.get('dest') or 'Unknown' }}</td>
                        <td>{{ t.get('platform') or '-' }}</td>
                        <td class="status {% if (t.get('etd','')|lower) not in ['on time','due',''] %}late{% endif %}">
                          {{ t.get('etd') or 'On time' }}
                        </td>
                        <td>{{ t.get('operator') or t.get('operatorName') or '' }}{% if t.get('operatorCode') %} ({{ t.get('operatorCode') }}){% endif %}</td>
                      {% else %}
                        <td colspan="5">{{ t }}</td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted">No train departures available</div>
        {% endif %}
      </main>

      <div class="weather panel">
        <div class="panel-title">Today's Weather</div>

        {% set segments = [] %}
        {% if weather %}
          {% if weather is mapping and weather.get('segments') is defined %}
            {% set segments = weather.get('segments') %}
          {% elif weather is mapping and weather.get('periods') is defined %}
            {% set segments = weather.get('periods') %}
          {% elif weather is mapping and weather.get('data') is defined and weather.get('data').get('segments') is defined %}
            {% set segments = weather.get('data').get('segments') %}
          {% elif weather is sequence %}
            {% set segments = weather %}
          {% endif %}
        {% endif %}

        {% if segments %}
          <div class="weather-grid">
            {% for seg in segments %}
              <div class="weather-seg">
                {% if seg is mapping %}
                  <div class="seg-title">{{ seg.get('title') or seg.get('name') or seg.get('period') or 'Weather' }}</div>
                  <div class="seg-main">{{ seg.get('summary') or seg.get('shortForecast') or seg.get('description') or '' }}</div>
                  {% if seg.get('temp') or seg.get('temperature') %}
                    <div class="seg-temp">{{ seg.get('temp') or seg.get('temperature') }}°</div>
                  {% endif %}
                {% else %}
                  <div class="seg-title">{{ seg }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">Weather unavailable</div>
        {% endif %}
      </div>
    </div>

    <div class="footer">
      <div class="muted">Data sources: National Rail / TFL / Weather</div>
      <div class="muted">Board auto-refreshes</div>
    </div>
  </div>
</body>
</html>